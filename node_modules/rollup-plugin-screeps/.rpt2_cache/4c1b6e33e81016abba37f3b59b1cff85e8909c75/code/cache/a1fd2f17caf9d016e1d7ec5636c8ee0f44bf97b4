{"code":"import { ScreepsAPI } from 'screeps-api';\r\nimport * as fs from 'fs';\r\nimport * as git from 'git-rev-sync';\r\nimport * as path from 'path';\r\nexport function generateSourceMaps(bundle) {\r\n    var b = bundle;\r\n    var tmp = b.map.toString;\r\n    delete b.map.sourceContent;\r\n    b.map.toString = function () {\r\n        return \"module.exports = \" + tmp.apply(this, arguments) + \";\";\r\n    };\r\n}\r\nexport function writeSourceMaps(options) {\r\n    fs.renameSync(options.file + '.map', options.file + '.map.js');\r\n}\r\nexport function validateConfig(cfg) {\r\n    if (cfg.hostname && cfg.hostname === 'screeps.com') {\r\n        return [\r\n            typeof cfg.token === \"string\",\r\n            cfg.protocol === \"http\" || cfg.protocol === \"https\",\r\n            typeof cfg.hostname === \"string\",\r\n            typeof cfg.port === \"number\",\r\n            typeof cfg.path === \"string\",\r\n            typeof cfg.branch === \"string\"\r\n        ].reduce(function (a, b) { return a && b; });\r\n    }\r\n    return [\r\n        (typeof cfg.email === 'string' && typeof cfg.password === 'string') || typeof cfg.token === 'string',\r\n        cfg.protocol === \"http\" || cfg.protocol === \"https\",\r\n        typeof cfg.hostname === \"string\",\r\n        typeof cfg.port === \"number\",\r\n        typeof cfg.path === \"string\",\r\n        typeof cfg.branch === \"string\"\r\n    ].reduce(function (a, b) { return a && b; });\r\n}\r\nexport function loadConfigFile(configFile) {\r\n    var data = fs.readFileSync(configFile, 'utf8');\r\n    var cfg = JSON.parse(data);\r\n    if (!validateConfig(cfg))\r\n        throw new TypeError(\"Invalid config\");\r\n    if (cfg.email && cfg.password && !cfg.token && cfg.hostname === 'screeps.com') {\r\n        console.log('Please change your email/password to a token');\r\n    }\r\n    return cfg;\r\n}\r\nexport function uploadSource(config, options, bundle) {\r\n    if (!config) {\r\n        console.log('screeps() needs a config e.g. screeps({configFile: \\'./screeps.json\\'}) or screeps({config: { ... }})');\r\n    }\r\n    else {\r\n        if (typeof config === \"string\")\r\n            config = loadConfigFile(config);\r\n        var code_1 = getFileList(options.file);\r\n        var branch_1 = getBranchName(config.branch);\r\n        var api_1 = new ScreepsAPI(config);\r\n        if (!config.token) {\r\n            api_1.auth().then(function () {\r\n                runUpload(api_1, branch_1, code_1);\r\n            });\r\n        }\r\n        else {\r\n            runUpload(api_1, branch_1, code_1);\r\n        }\r\n    }\r\n}\r\nexport function runUpload(api, branch, code) {\r\n    api.raw.user.branches().then(function (data) {\r\n        var branches = data.list.map(function (b) { return b.branch; });\r\n        if (branches.includes(branch)) {\r\n            api.code.set(branch, code);\r\n        }\r\n        else {\r\n            api.raw.user.cloneBranch('', branch, code);\r\n        }\r\n    });\r\n}\r\nexport function getFileList(outputFile) {\r\n    var code = {};\r\n    var base = path.dirname(outputFile);\r\n    var files = fs.readdirSync(base).filter(function (f) { return path.extname(f) === '.js'; });\r\n    files.map(function (file) {\r\n        code[file.replace(/\\.js$/i, '')] = fs.readFileSync(path.join(base, file), 'utf8');\r\n    });\r\n    return code;\r\n}\r\nexport function getBranchName(branch) {\r\n    if (branch === 'auto') {\r\n        return git.branch();\r\n    }\r\n    else {\r\n        return branch;\r\n    }\r\n}\r\nexport function screeps(screepsOptions) {\r\n    if (screepsOptions === void 0) { screepsOptions = {}; }\r\n    return {\r\n        name: \"screeps\",\r\n        ongenerate: function (options, bundle) {\r\n            if (options.sourcemap)\r\n                generateSourceMaps(bundle);\r\n        },\r\n        onwrite: function (options, bundle) {\r\n            if (options.sourcemap)\r\n                writeSourceMaps(options);\r\n            if (!screepsOptions.dryRun) {\r\n                uploadSource((screepsOptions.configFile || screepsOptions.config), options, bundle);\r\n            }\r\n        }\r\n    };\r\n}\r\nexport default screeps;\r\n//# sourceMappingURL=rollup-plugin-screeps.js.map","map":{"version":3,"file":"rollup-plugin-screeps.js","sourceRoot":"","sources":["rollup-plugin-screeps.ts"],"names":[],"mappings":"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"},"dts":{"name":"C:\\Code\\Typescript\\rollup-plugin-screeps/src/rollup-plugin-screeps.d.ts","text":"import { Plugin, OutputOptions, SourceDescription } from 'rollup';\r\nexport interface ScreepsConfig {\r\n    token?: string;\r\n    email?: string;\r\n    password?: string;\r\n    protocol: \"http\" | \"https\";\r\n    hostname: string;\r\n    port: number;\r\n    path: string;\r\n    branch: string | \"auto\";\r\n}\r\nexport interface ScreepsOptions {\r\n    configFile?: string;\r\n    config?: ScreepsConfig;\r\n    dryRun?: boolean;\r\n}\r\nexport interface CodeList {\r\n    [key: string]: string;\r\n}\r\nexport declare function generateSourceMaps(bundle: SourceDescription): void;\r\nexport declare function writeSourceMaps(options: OutputOptions): void;\r\nexport declare function validateConfig(cfg: Partial<ScreepsConfig>): cfg is ScreepsConfig;\r\nexport declare function loadConfigFile(configFile: string): ScreepsConfig;\r\nexport declare function uploadSource(config: string | ScreepsConfig, options: OutputOptions, bundle: SourceDescription): void;\r\nexport declare function runUpload(api: any, branch: string, code: CodeList): void;\r\nexport declare function getFileList(outputFile: string): CodeList;\r\nexport declare function getBranchName(branch: string): string | undefined;\r\nexport declare function screeps(screepsOptions?: ScreepsOptions): Plugin;\r\nexport default screeps;\r\n"}}
