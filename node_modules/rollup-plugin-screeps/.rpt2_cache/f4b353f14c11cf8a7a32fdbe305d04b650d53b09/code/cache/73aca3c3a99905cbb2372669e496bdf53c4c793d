{"code":"import { ScreepsAPI } from 'screeps-api';\r\nimport * as fs from 'fs';\r\nimport * as git from 'git-rev-sync';\r\nimport * as path from 'path';\r\nexport function screeps(screepsOptions) {\r\n    if (screepsOptions === void 0) { screepsOptions = {}; }\r\n    return {\r\n        name: \"screeps\",\r\n        ongenerate: function (options, bundle) {\r\n            if (options.sourcemap) {\r\n                generateSourceMaps(bundle);\r\n            }\r\n        },\r\n        onwrite: function (options, bundle) {\r\n            if (options.sourcemap) {\r\n                writeSourceMaps(options);\r\n            }\r\n            if (!screepsOptions.dryRun) {\r\n                uploadSource(screepsOptions.configFile, options, bundle);\r\n            }\r\n        }\r\n    };\r\n}\r\nexport function generateSourceMaps(bundle) {\r\n    var tmp = bundle.map.toString;\r\n    delete bundle.map.sourceContent;\r\n    bundle.map.toString = function () {\r\n        return \"module.exports = \" + tmp.apply(this, arguments) + \";\";\r\n    };\r\n}\r\nexport function writeSourceMaps(options) {\r\n    fs.renameSync(options.file + '.map', options.file + '.map.js');\r\n}\r\nexport function uploadSource(configFile, options, bundle) {\r\n    if (!configFile) {\r\n        console.log('screeps() needs the path of your config file e.g. screeps({configFile: \\'./screeps.json\\'})');\r\n        return;\r\n    }\r\n    else {\r\n        var config = getConfig(configFile);\r\n        var code_1 = getFileList(options.file);\r\n        var branch_1 = getBranchName(config.branch);\r\n        var api_1 = new ScreepsAPI();\r\n        api_1.setServer(config);\r\n        api_1.auth().then(function () {\r\n            api_1.raw.user.branches().then(function (data) {\r\n                var branches = data.list.map(function (b) { return b.branch; });\r\n                if (branches.includes(branch_1)) {\r\n                    api_1.code.set(branch_1, code_1);\r\n                }\r\n                else {\r\n                    api_1.raw.user.cloneBranch('', branch_1, code_1);\r\n                }\r\n            });\r\n        });\r\n    }\r\n}\r\nexport function getConfig(configFile) {\r\n    var data = fs.readFileSync(configFile, 'utf8');\r\n    return JSON.parse(data);\r\n}\r\nexport function getFileList(outputFile) {\r\n    var code = {};\r\n    var base = path.dirname(outputFile);\r\n    var files = fs.readdirSync(base).filter(function (f) { return path.extname(f) === '.js'; });\r\n    files.map(function (file) {\r\n        code[file.replace(/\\.js$/i, '')] = fs.readFileSync(path.join(base, file), 'utf8');\r\n    });\r\n    return code;\r\n}\r\nexport function getBranchName(branch) {\r\n    if (branch === 'auto') {\r\n        return git.branch();\r\n    }\r\n    else {\r\n        return branch;\r\n    }\r\n}\r\nexport default screeps;\r\n//# sourceMappingURL=rollup-plugin-screeps.js.map","map":{"version":3,"file":"rollup-plugin-screeps.js","sourceRoot":"","sources":["rollup-plugin-screeps.ts"],"names":[],"mappings":"AAAA,OAAO,EAAC,UAAU,EAAC,MAAM,aAAa,CAAA;AACtC,OAAO,KAAK,EAAE,MAAM,IAAI,CAAA;AACxB,OAAO,KAAK,GAAG,MAAM,cAAc,CAAA;AACnC,OAAO,KAAK,IAAI,MAAM,MAAM,CAAA;AAE5B,MAAM,kBAAkB,cAAmC;IAAnC,+BAAA,EAAA,mBAAmC;IACzD,MAAM,CAAC;QACL,IAAI,EAAE,SAAS;QACf,UAAU,EAAE,UAAC,OAAY,EAAE,MAAW;YACpC,EAAE,CAAA,CAAC,OAAO,CAAC,SAAS,CAAC,CAAA,CAAC;gBACpB,kBAAkB,CAAC,MAAM,CAAC,CAAA;YAC5B,CAAC;QACH,CAAC;QACD,OAAO,EAAE,UAAC,OAAY,EAAE,MAAW;YACjC,EAAE,CAAA,CAAC,OAAO,CAAC,SAAS,CAAC,CAAA,CAAC;gBACpB,eAAe,CAAC,OAAO,CAAC,CAAA;YAC1B,CAAC;YAED,EAAE,CAAA,CAAC,CAAC,cAAc,CAAC,MAAM,CAAC,CAAA,CAAC;gBACzB,YAAY,CAAC,cAAc,CAAC,UAAW,EAAE,OAAO,EAAE,MAAM,CAAC,CAAA;YAC3D,CAAC;QACH,CAAC;KACF,CAAA;AACH,CAAC;AAED,MAAM,6BAA6B,MAAW;IAC5C,IAAI,GAAG,GAAG,MAAM,CAAC,GAAG,CAAC,QAAQ,CAAA;IAE7B,OAAO,MAAM,CAAC,GAAG,CAAC,aAAa,CAAA;IAE/B,MAAM,CAAC,GAAG,CAAC,QAAQ,GAAG;QACpB,MAAM,CAAC,mBAAmB,GAAG,GAAG,CAAC,KAAK,CAAC,IAAI,EAAE,SAAS,CAAC,GAAG,GAAG,CAAC;IAChE,CAAC,CAAA;AACH,CAAC;AAED,MAAM,0BAA0B,OAAY;IAC1C,EAAE,CAAC,UAAU,CACX,OAAO,CAAC,IAAI,GAAG,MAAM,EACrB,OAAO,CAAC,IAAI,GAAG,SAAS,CACzB,CAAA;AACH,CAAC;AAED,MAAM,uBAAuB,UAAkB,EAAE,OAAY,EAAE,MAAW;IACxE,EAAE,CAAA,CAAC,CAAC,UAAU,CAAC,CAAA,CAAC;QACd,OAAO,CAAC,GAAG,CAAC,6FAA6F,CAAC,CAAA;QAC1G,MAAM,CAAA;IACR,CAAC;IAAA,IAAI,CAAA,CAAC;QACJ,IAAI,MAAM,GAAG,SAAS,CAAC,UAAU,CAAC,CAAA;QAClC,IAAI,MAAI,GAAG,WAAW,CAAC,OAAO,CAAC,IAAI,CAAC,CAAA;QACpC,IAAI,QAAM,GAAG,aAAa,CAAC,MAAM,CAAC,MAAM,CAAC,CAAA;QAEzC,IAAI,KAAG,GAAG,IAAI,UAAU,EAAE,CAAA;QAE1B,KAAG,CAAC,SAAS,CAAC,MAAM,CAAC,CAAA;QACrB,KAAG,CAAC,IAAI,EAAE,CAAC,IAAI,CAAC;YACd,KAAG,CAAC,GAAG,CAAC,IAAI,CAAC,QAAQ,EAAE,CAAC,IAAI,CAAC,UAAC,IAAS;gBACrC,IAAI,QAAQ,GAAG,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,UAAC,CAAM,IAAK,OAAA,CAAC,CAAC,MAAM,EAAR,CAAQ,CAAC,CAAA;gBAElD,EAAE,CAAA,CAAC,QAAQ,CAAC,QAAQ,CAAC,QAAM,CAAC,CAAC,CAAA,CAAC;oBAC5B,KAAG,CAAC,IAAI,CAAC,GAAG,CAAC,QAAM,EAAE,MAAI,CAAC,CAAA;gBAC5B,CAAC;gBAAA,IAAI,CAAA,CAAC;oBACJ,KAAG,CAAC,GAAG,CAAC,IAAI,CAAC,WAAW,CAAC,EAAE,EAAE,QAAM,EAAE,MAAI,CAAC,CAAA;gBAC5C,CAAC;YACH,CAAC,CAAC,CAAA;QACJ,CAAC,CAAC,CAAA;IACJ,CAAC;AACH,CAAC;AAED,MAAM,oBAAoB,UAAkB;IAC1C,IAAI,IAAI,GAAG,EAAE,CAAC,YAAY,CAAC,UAAU,EAAE,MAAM,CAAC,CAAA;IAC9C,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,CAAA;AACzB,CAAC;AAED,MAAM,sBAAsB,UAAkB;IAC5C,IAAI,IAAI,GAAa,EAAE,CAAA;IACvB,IAAI,IAAI,GAAG,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,CAAA;IACnC,IAAI,KAAK,GAAG,EAAE,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC,MAAM,CAAC,UAAC,CAAC,IAAK,OAAA,IAAI,CAAC,OAAO,CAAC,CAAC,CAAC,KAAK,KAAK,EAAzB,CAAyB,CAAC,CAAA;IACzE,KAAK,CAAC,GAAG,CAAC,UAAC,IAAI;QACb,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,QAAQ,EAAE,EAAE,CAAC,CAAC,GAAG,EAAE,CAAC,YAAY,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC,EAAE,MAAM,CAAC,CAAA;IACnF,CAAC,CAAC,CAAA;IACF,MAAM,CAAC,IAAI,CAAA;AACb,CAAC;AAED,MAAM,wBAAwB,MAAc;IAC1C,EAAE,CAAA,CAAC,MAAM,KAAK,MAAM,CAAC,CAAA,CAAC;QACpB,MAAM,CAAC,GAAG,CAAC,MAAM,EAAE,CAAA;IACrB,CAAC;IAAA,IAAI,CAAA,CAAC;QACJ,MAAM,CAAC,MAAM,CAAA;IACf,CAAC;AACH,CAAC;AAED,eAAe,OAAO,CAAA"}}
